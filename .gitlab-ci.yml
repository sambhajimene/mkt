stages:
  - build
  - deploy

variables:
  IMAGE_TAG: latest
  IMAGE_NAME: quay.io/sambhajimene/mk
  FULL_IMAGE: $IMAGE_NAME:$IMAGE_TAG

  OPENSHIFT_PROJECT: sambhajimene-dev
  APP_NAME: mk
  APP_PORT: "5009"

# =====================
# BUILD & PUSH (Docker Buildx)
# =====================
build_and_push:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - echo "üîê Login to Quay.io"
    - docker login quay.io -u "$QUAY_USER" -p "$QUAY_PASSWORD"

    - echo "üîß Enable Docker Buildx"
    - docker buildx create --use

    - echo "üî® Build & Push image (linux/amd64)"
    - docker buildx build \
        --platform linux/amd64 \
        -t $FULL_IMAGE \
        --push .

# =====================
# DEPLOY TO OPENSHIFT
# =====================
deploy:
  stage: deploy
  image: quay.io/openshift/origin-cli:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - echo "üîê Login to OpenShift"
    - oc login "$OPENSHIFT_SERVER" \
        --token="$OPENSHIFT_TOKEN" \
        --insecure-skip-tls-verify=true

    - echo "üì¶ Select project"
    - oc project "$OPENSHIFT_PROJECT"

    - echo "üöÄ Create or update deployment"
    - |
      oc get deploy $APP_NAME >/dev/null 2>&1 || \
      oc create deployment $APP_NAME --image=$FULL_IMAGE

    - oc set image deploy/$APP_NAME $APP_NAME=$FULL_IMAGE

    # ---- Secret (safe recreate)
    - echo "üîê Create email secret"
    - |
      oc delete secret email-secret --ignore-not-found
      oc create secret generic email-secret \
        --from-literal=EMAIL_FROM="$EMAIL_FROM" \
        --from-literal=EMAIL_PASS="$EMAIL_PASS" \
        --from-literal=EMAIL_TO="$EMAIL_TO"

    - oc set env deploy/$APP_NAME --from=secret/email-secret
    - oc rollout restart deploy/$APP_NAME
    - oc rollout status deploy/$APP_NAME

    # ---- Service
    - echo "üîå Ensure service"
    - |
      oc get svc $APP_NAME >/dev/null 2>&1 || \
      oc create service clusterip $APP_NAME --tcp=$APP_PORT:$APP_PORT

    # ---- Route
    - echo "üåê Ensure route"
    - |
      oc get route $APP_NAME >/dev/null 2>&1 || \
      oc expose svc $APP_NAME --port=$APP_PORT

    - echo "‚úÖ Deployment completed"
    - echo "üåç Application URL:"
    - oc get route $APP_NAME -o jsonpath='http://{.spec.host}'
    - echo ""
