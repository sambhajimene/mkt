stages:
  - build_and_push
  - deploy

variables:
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  IMAGE_NAME: quay.io/sambhajimene/mk
  FULL_IMAGE: quay.io/sambhajimene/mk:$CI_COMMIT_SHORT_SHA
  OPENSHIFT_PROJECT: sambhajimene-dev
  APP_NAME: mk
  APP_PORT: 5010

# =====================
# BUILD & PUSH
# =====================
build_and_push:
  stage: build_and_push
  image: quay.io/buildah/stable:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "**/*.py"
        - Dockerfile
        - requirements.txt
    - when: never
  script:
    - echo "üî® Building image $FULL_IMAGE"
    - buildah bud -t $FULL_IMAGE .
    - echo "üîê Logging in to Quay.io"
    - buildah login -u $QUAY_USER -p $QUAY_PASSWORD quay.io
    - echo "üì§ Pushing image $FULL_IMAGE to Quay.io"
    - buildah push $FULL_IMAGE docker://$FULL_IMAGE

# =====================
# DEPLOY
# =====================
deploy:
  stage: deploy
  image: quay.io/openshift/origin-cli:latest
  script:
    # ---------------------
    # LOGIN
    # ---------------------
    - echo "üîê Login to OpenShift"
    - oc login "$OPENSHIFT_SERVER" --token="$OPENSHIFT_TOKEN" --insecure-skip-tls-verify=true

    - echo "üì¶ Select project"
    - oc project "$OPENSHIFT_PROJECT"

    # ---------------------
    # DEPLOYMENT
    # ---------------------
    - echo "üöÄ Creating deployment if missing"
    - oc get deploy $APP_NAME || oc create deployment $APP_NAME --image=$FULL_IMAGE

    - echo "‚ôªÔ∏è Updating image (triggers rollout)"
    - oc set image deploy/$APP_NAME $APP_NAME=$FULL_IMAGE

    - echo "‚è≥ Waiting for rollout to complete"
    - oc rollout status deploy/$APP_NAME --timeout=180s

    # ---------------------
    # SERVICE
    # ---------------------
    - echo "üîå Creating Service (if not exists)"
    - |
      oc get svc $APP_NAME >/dev/null 2>&1 || \
      oc create service clusterip $APP_NAME --tcp=$APP_PORT:$APP_PORT

    # ---------------------
    # ROUTE
    # ---------------------
    - echo "üåê Creating Route (if not exists)"
    - |
      oc get route $APP_NAME >/dev/null 2>&1 || \
      oc create route edge $APP_NAME --service=$APP_NAME --port=$APP_PORT

    # ---------------------
    # OUTPUT
    # ---------------------
    - echo "‚úÖ Deployment & Rollout completed"
    - echo "üåç Application URL:"
    - oc get route $APP_NAME -o jsonpath='http://{.spec.host}'
    - echo ""
  only:
    - main
