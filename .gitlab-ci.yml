stages:
  - build
  - push
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  IMAGE_NAME: "$QUAY_REPO:latest"

# ---------------- BUILD ----------------
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "ðŸ” Login to Quay"
    - echo "$QUAY_PASSWORD" | docker login -u "$QUAY_USER" --password-stdin quay.io

    - echo "ðŸ—ï¸ Building Docker image"
    - docker build -t $IMAGE_NAME .
  only:
    - main

# ---------------- PUSH ----------------
push:
  stage: push
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "ðŸ” Login to Quay"
    - echo "$QUAY_PASSWORD" | docker login -u "$QUAY_USER" --password-stdin quay.io

    - echo "ðŸ“¤ Pushing image to Quay"
    - docker push $IMAGE_NAME
  only:
    - main

# ---------------- DEPLOY ----------------
deploy:
  stage: deploy
  image: quay.io/openshift/origin-cli:latest
  script:
    - echo "ðŸ” Login to OpenShift"
    - oc login "$OPENSHIFT_SERVER" --token="$OPENSHIFT_TOKEN" --insecure-skip-tls-verify=true

    - echo "ðŸ“¦ Select project"
    - oc project "$OPENSHIFT_PROJECT"

    - echo "ðŸš€ Deploying application"
    - |
      oc get deployment mk >/dev/null 2>&1 || \
      oc create deployment mk --image=$IMAGE_NAME

    - oc set image deployment/mk mk=$IMAGE_NAME
    - oc rollout status deployment/mk
  only:
    - main
